name: Deploy to VPS

on:
  workflow_dispatch: 
  
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Connect to VPS and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          script_stop: true
          debug: true
          script: |
            cd ~/projects/infra && \
            echo "=== BEFORE DEPLOY: docker ps ===" && \
            docker ps && \
            echo "=== BEFORE DEPLOY: docker images ===" && \
            docker images && \
            docker compose down www || true && \
            docker compose pull www && \
            docker compose up -d www && \
            echo "=== AFTER DEPLOY: docker ps ===" && \
            docker ps && \
            echo "=== AFTER DEPLOY: docker images ===" && \
            docker images
